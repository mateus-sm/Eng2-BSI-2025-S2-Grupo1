<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar - DM Info</title>

    <link rel="shortcut icon" type="image/png" th:href="@{/images/BrasãoDemolay.png}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/styles/login.css}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="container container-register">
    <div class="logo">
        <img th:src="@{/images/BrasãoDemolay.png}" alt="Logo DM Info" class="logo-img">
    </div>

    <h1>Registrar</h1>
    <h3>Crie sua conta</h3>

    <form class="login-form" th:action="@{/register}" method="POST" novalidate>

        <div th:if="${sucesso}" class="alert alert-success w-100" role="alert">
            <span th:text="${sucesso}"></span>
        </div>

        <div class="row g-2 w-100">

            <div class="col-md-6">
                <input type="text" name="nome" placeholder="Nome Completo" required class="form-control" th:value="${nome}" />
                <span th:if="${nome_error}" th:text="${nome_error}" class="error"></span>
            </div>

            <div class="col-md-6">
                <input type="text" name="cpf" id="cpf" placeholder="CPF" required class="form-control" th:value="${cpf}" maxlength="14" />
                <span th:if="${cpf_error}" th:text="${cpf_error}" class="error"></span>
            </div>

            <div class="col-md-6">
                <input type="text" name="usuario" placeholder="Login (usuário)" required class="form-control" th:value="${usuario}" />
                <span th:if="${usuario_error}" th:text="${usuario_error}" class="error"></span>
            </div>

            <div class="col-md-6">
                <input type="password" name="senha" placeholder="Senha" required class="form-control" />
            </div>

            <div class="col-md-6">
                <input type="email" name="email" placeholder="E-mail" required class="form-control" th:value="${email}" />
                <span th:if="${email_error}" th:text="${email_error}" class="error"></span>
            </div>

            <div class="col-md-6">
                <input type="tel" name="telefone" id="telefone" placeholder="Telefone" required class="form-control" th:value="${telefone}" />
            </div>

            <div class="col-md-6">
                <input type="text" id="dtnasc" name="dtnasc" placeholder="Data de Nascimento (dd/mm/aaaa)" class="form-control" th:value="${dtnasc}" required>
                <span th:if="${dtnasc_error}" th:text="${dtnasc_error}" class="error"></span>
            </div>

            <div class="col-md-6">
                <input type="text" name="cep" id="cep" placeholder="CEP" required class="form-control" th:value="${cep}" maxlength="9" />
            </div>
            <div class="col-12">
                <input type="text" name="rua" id="rua" placeholder="Rua / Endereço" required class="form-control" th:value="${rua}" />
            </div>
            <div class="col-md-6">
                <input type="text" name="bairro" id="bairro" placeholder="Bairro" required class="form-control" th:value="${bairro}" />
            </div>
            <div class="col-md-4">
                <input type="text" name="cidade" id="cidade" placeholder="Cidade" required class="form-control" th:value="${cidade}" />
            </div>
            <div class="col-md-2">
                <input type="text" name="uf" id="uf" placeholder="UF" maxlength="2" required class="form-control" th:value="${uf}" />
            </div>
        </div>

        <button type="submit" class="btn-register">Registrar</button>
        <a href="/login" class="register-link">Já tenho conta</a>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cpfInput = document.getElementById('cpf');
        const telInput = document.getElementById('telefone');
        const dateInput = document.getElementById('dtnasc');
        const cepInput = document.getElementById('cep');
        const form = document.querySelector('.login-form');

        // Máscara de CPF
        if (cpfInput) {
            cpfInput.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '');
                v = v.replace(/(\d{3})(\d)/, '$1.$2');
                v = v.replace(/(\d{3})(\d)/, '$1.$2');
                v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = v.substring(0, 14);
            });
        }

        // Máscara de CEP
        if (cepInput) {
            cepInput.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, "");
                v = v.replace(/^(\d{5})(\d)/, "$1-$2");
                e.target.value = v.substring(0, 9);
            });

            cepInput.addEventListener("blur", function () {
                const cep = this.value.replace(/\D/g, "");
                if (cep.length !== 8) return;
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(r => r.json()).then(d => {
                    if (!d.erro) {
                        if(document.getElementById('rua')) document.getElementById('rua').value = d.logradouro || "";
                        if(document.getElementById('bairro')) document.getElementById('bairro').value = d.bairro || "";
                        if(document.getElementById('cidade')) document.getElementById('cidade').value = d.localidade || "";
                        if(document.getElementById('uf')) document.getElementById('uf').value = d.uf || "";
                    }
                });
            });
        }

        // Máscara de Telefone
        if (telInput) {
            telInput.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '');
                v = v.replace(/^(\d{2})(\d)/, '($1) $2');
                v = v.replace(/(\d{5})(\d{1,4})$/, '$1-$2');
                e.target.value = v.substring(0, 15);
            });
        }

        // Máscara de Data
        if (dateInput) {
            dateInput.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 8) v = v.substring(0, 8);

                if (v.length > 4) {
                    v = v.replace(/^(\d{2})(\d{2})(\d)/, '$1/$2/$3');
                } else if (v.length > 2) {
                    v = v.replace(/^(\d{2})(\d)/, '$1/$2');
                }
                e.target.value = v;
            });
        }


        if (form) {
            form.addEventListener('submit', () => {

                //if (cpfInput) cpfInput.value = cpfInput.value.replace(/\D/g, ''); // Limpa CPF
                if (cepInput) cepInput.value = cepInput.value.replace(/\D/g, ''); // Limpa CEP
                if (telInput) telInput.value = telInput.value.replace(/\D/g, ''); // Limpa Telefone
            });
        }

        const inputsComErro = document.querySelectorAll('.error');
        if(inputsComErro.length > 0) {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(inp => {
                inp.addEventListener('input', () => {
                    const span = inp.parentNode.querySelector('.error');
                    if(span) span.style.display = 'none';
                });
            });
        }
    });
</script>

</body>
</html>